–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π Python-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫. –°–æ–∑–¥–∞–π –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, production-ready Telegram-–±–æ—Ç —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏.

# –°—Ç–µ–∫ –∏ –≤–µ—Ä—Å–∏–∏
- Python 3.13
- Aiogram 3.22 (async)
- SQLAlchemy 2.0 (async engine + async_sessionmaker)
- Redis 7: FSM (aiogram), –∫—ç—à
- Postgres 15+
- pydantic 2.x + pydantic-settings
- –í–µ–±—Ö—É–∫–∏. –û–±—ë—Ä—Ç–∫–∞ –ø–æ–¥ Caddy reverse_proxy.
- –õ–∏–Ω—Ç: PEP-8, —Ç–∏–ø–∏–∑–∞—Ü–∏—è (mypy-friendly), –û–û–ü, —Å–ª–æ–∏.

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- package `app/`:
  - `config/` (settings.py ‚Äî pydantic-settings, env)
  - `db/`:
    - `base.py` (engine + async_sessionmaker)
    - `models.py` (—Å–º. –º–æ–¥–µ–ª–∏ –Ω–∏–∂–µ)
    - `migrations/` (Alembic)
    - `repo/` (—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å CRUD, —Å—Ç—Ä–æ–≥–æ async, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
  - `cache/redis.py` (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Redis, –æ–±—ë—Ä—Ç–∫–∏ get/set, locks)
  - `services/`:
    - `tickets.py` (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤: —Å–æ–∑–¥–∞–Ω–∏–µ, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏–∫–∞, —Å–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞, –∑–µ—Ä–∫–∞–ª—å–Ω—ã–µ —Ç–æ–ø–∏–∫–∏)
    - `bridge.py` (–º–æ—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π: –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏, –∞–Ω—Ç–∏-–ø–µ—Ç–ª—è, —Ñ–∏–ª—å—Ç—Ä—ã)
    - `feedback.py` (–æ–ø—Ä–æ—Å 3 –≤–æ–ø—Ä–æ—Å–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∑–∞–ø–∏—Å—å –≤ –ë–î)
    - `sheets.py` (–∞–¥–∞–ø—Ç–µ—Ä –∫ Google Sheets; –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å + –∑–∞–≥–ª—É—à–∫–∞/—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
  - `bot/`:
    - `main.py` (–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞, Dispatcher, —Ä–æ—É—Ç–µ—Ä—ã, webhook)
    - `routers/`:
      - `client.py` (–ª–∏—á–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞: –≤—Ö–æ–¥—è—â–∏–µ, FSM)
      - `main_group.py` (–≥–ª–∞–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞: —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–∫–µ—Ç–∞, –≤—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∞, –æ—Ç–≤–µ—Ç—ã –æ—Ç –∏–º–µ–Ω–∏ –¢–ü)
      - `tech_group.py` (–≥—Ä—É–ø–ø—ã —Ç–µ—Ö–Ω–∏–∫–æ–≤: –æ—Ç–≤–µ—Ç—ã –∫–ª–∏–µ–Ω—Ç—É, –≤—ã–∑–æ–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞)
      - `admin.py` (–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è: —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–∏–∫–æ–≤, —Å—Ç–∞—Ç—É—Å—ã, –ø–æ–∏—Å–∫ —Ç–∏–∫–µ—Ç–∞)
    - `filters.py` (—á–∞—Ç—ã/—Ç–æ–ø–∏–∫–∏/—Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π)
    - `keyboards.py` (–∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏: –≤—ã–±–æ—Ä —Ç–µ—Ö–Ω–∏–∫–∞, –∑–∞–∫—Ä—ã—Ç—å, –æ—Ü–µ–Ω–∫–∞ 1‚Äì5, ¬´–¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π¬ª)
    - `middlewares.py` (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–Ω—Ç–∏-–¥—É–±–ª–∏ –Ω–∞ –∞–ø–¥–µ–π—Ç–∞—Ö)
    - `states.py` (FSM –æ–ø—Ä–æ—Å–∞)
  - `logger.py` (—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ª–æ–≥–≥–µ—Ä)
  - `web/`:
    - `server.py` (FastAPI/ASGI –¥–ª—è webhook, /healthz)
- –ö–æ—Ä–µ–Ω—å:
  - `Dockerfile`, `docker-compose.yml` (bot + postgres + redis –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏)
  - `.env.example`
  - `README.md`

# –ú–æ–¥–µ–ª–∏ –ë–î (–º–∏–Ω–∏–º—É–º)
- User(tg_id PK, username, full_name, created_at, last_seen)
- Technician(id PK, name, tg_user_id nullable, group_chat_id, is_active)
- Ticket(id PK, client_tg_id FK‚ÜíUser, status enum[NEW,WORK,CLOSED], main_chat_id, main_thread_id, assigned_tech_id FK‚ÜíTechnician nullable, created_at, closed_at nullable)
- TechThread(id PK, ticket_id FK, tech_id FK, tech_chat_id, tech_thread_id, created_at)
- Feedback(id PK, ticket_id FK, q1 int, q2 int, q3 int, comment text, created_at)
- Event(id PK, ticket_id FK, actor enum[CLIENT,TECH,STAFF,SYSTEM], action str, payload jsonb, ts)

–ò–Ω–¥–µ–∫—Å—ã: –ø–æ (client_tg_id, status), (assigned_tech_id, status), –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö.

# –ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (Bridge)
- –í—Ö–æ–¥—è—â–µ–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:
  - –Ω–∞–π—Ç–∏ –æ—Ç–∫—Ä—ã—Ç—ã–π —Ç–∏–∫–µ—Ç, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π (—Å—Ç–∞—Ç—É—Å NEW, üü¢, —Å–æ–∑–¥–∞—Ç—å —Ç–µ–º—É –≤ –≥–ª–∞–≤–Ω–æ–π –≥—Ä—É–ø–ø–µ);
  - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞ (–∏–∑ sheets) –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥–ª–∞–≤–Ω—ã–π —Ç–æ–ø–∏–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ—Ö–Ω–∏–∫–∞.
- Callback ¬´–Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ—Ö–Ω–∏–∫–∞ X¬ª –≤ –≥–ª–∞–≤–Ω–æ–π —Ç–µ–º–µ:
  - —Å–æ–∑–¥–∞—Ç—å/–Ω–∞–π—Ç–∏ –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π —Ç–æ–ø–∏–∫ –≤ –≥—Ä—É–ø–ø–µ —Ç–µ—Ö–Ω–∏–∫–∞ X;
  - –≤–∫–ª—é—á–∏—Ç—å –º–æ—Å—Ç: –∫–ª–∏–µ–Ω—Ç ‚Üî tech-—Ç–µ–º–∞; tech-–æ—Ç–≤–µ—Ç—ã –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω—ã–π —Ç–æ–ø–∏–∫;
  - –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≥–ª–∞–≤–Ω–æ–π —Ç–µ–º—ã: üü° –í —Ä–∞–±–æ—Ç–µ | @tech.
- –û—Ç–≤–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∞ –∏–∑ —Å–≤–æ–µ–π —Ç–µ–º—ã:
  - –¥–æ—Å—Ç–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –≤ –ª–∏—á–∫—É; –ø—Ä–æ–¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≥–ª–∞–≤–Ω—ã–π —Ç–æ–ø–∏–∫ (–∫—Ä–æ–º–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö/–∫–æ–º–∞–Ω–¥).
- –ü—Ä–∏–∑—ã–≤ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞ (¬´@... –ø–æ–º–æ–≥–∏¬ª):
  - –æ—Ç–º–µ—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ, –Ω–æ –Ω–µ –º–æ—Å—Ç–∏—Ç—å –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É.
- –ó–∞–∫—Ä—ã—Ç–∏–µ —Ç–∏–∫–µ—Ç–∞:
  - —Å—Ç–∞—Ç—É—Å üü£, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –º–æ—Å—Ç; –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –æ–ø—Ä–æ—Å.
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è/–∞–Ω—Ç–∏-–ø–µ—Ç–ª—è:
  - –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã `/...`, —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–æ–≤, join/leave;
  - Redis-–∫–ª—é—á–∏ –¥–ª—è —É–∂–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–Ω—ã—Ö `(src_chat, msg_id)` c TTL 2h.

# –°—Ç–∞—Ç—É—Å—ã –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–µ–º (–≥–ª–∞–≤–Ω–∞—è –≥—Ä—É–ø–ø–∞)
- NEW: "üü¢ [–ù–æ–≤—ã–π] #<id> | –ò–º—è (@user)"
- WORK: "üü° [–í —Ä–∞–±–æ—Ç–µ | @tech] #<id> | –ò–º—è"
- CLOSED: "üü£ [–ó–∞–∫—Ä—ã—Ç | @tech] #<id> | –ò–º—è"

# –û–ø—Ä–æ—Å (Feedback)
- 3 –≤–æ–ø—Ä–æ—Å–∞, —à–∫–∞–ª–∞ 1‚Äì5 (–∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏).
- –ï—Å–ª–∏ –ª—é–±–∞—è –æ—Ü–µ–Ω–∫–∞ <5 ‚Äî –∑–∞–ø—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ¬´—á—Ç–æ —É–ª—É—á—à–∏—Ç—å¬ª.
- –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î; –∫–æ—Ä–æ—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –≤ –≥–ª–∞–≤–Ω—ã–π —Ç–æ–ø–∏–∫.

# Redis
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ pooled, namespaces: fsm:, cache:, fwd:
- –ö—ç—à–∏: —Ç–µ—Ö–Ω–∏–∫–∏ (10 –º–∏–Ω), –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ (15 –º–∏–Ω).
- Lock –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É callback (60 —Å–µ–∫).

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `.env`: BOT_TOKEN, WEBHOOK_URL, MAIN_GROUP_ID, SHEETS_CREDS, POSTGRES_*, REDIS_*, TECH_GROUPS_MAPPING (json).
- pydantic-settings; –≤–∞–ª–∏–¥–∞—Ü–∏—è.

# –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- ASGI-—Å–µ—Ä–≤–µ—Ä + —Ä–æ—É—Ç `/webhook/{secret}`; /healthz.
- Docker-compose: bot, postgres, redis –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏.
- Caddy –ø—Ä–∏–º–µ—Ä (reverse_proxy) –≤ README.
- Alembic –∞–≤—Ç–æ-–º–∏–≥—Ä–∞—Ü–∏–∏.

# –ö–∞—á–µ—Å—Ç–≤–æ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ JSON, –∫–æ—Ä–µ–ª—è—Ü–∏—è –ø–æ ticket_id.
- –ò—Å–∫–ª—é—á–µ–Ω–∏—è ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –Ω–µ –≤–∞–ª–∏–º –ø—Ä–æ—Ü–µ—Å—Å.
- mypy (strict), ruff/flake8.

# –¢–µ—Å—Ç—ã
- –Æ–Ω–∏—Ç: —Å–µ—Ä–≤–∏—Å—ã tickets/bridge/feedback (pytest, async).
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –∏–º–∏—Ç–∞—Ü–∏—è –∞–ø–¥–µ–π—Ç–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞/—Ç–µ—Ö–Ω–∏–∫–∞/–≥–ª–∞–≤–Ω–æ–π –≥—Ä—É–ø–ø—ã.

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–µ–∫—Ç —Å —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, –≥–æ—Ç–æ–≤—ã–π –∫ –∑–∞–ø—É—Å–∫—É `docker compose up -d` (–ø–µ—Ä–≤—ã–π —Å—Ç–∞—Ä—Ç —Å–∞–º –ø—Ä–∏–º–µ–Ω—è–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏). –í README —Ä–∞—Å–ø–∏—à–∏ .env –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏.
